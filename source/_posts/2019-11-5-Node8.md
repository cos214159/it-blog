---
title: node.js 筆記 8 - Restful API
date: 2019-11-05 08:42:07
tags:
  - Node
categories: 前端
---

在以往網路應用比較單純的時候，後端只需要回傳頁面回 client 端，並且搭配 JavaScript 便可以做到簡單的應用，但現今的移動端設備越來越多樣，而該移動端顯示上不需要依靠 HTML，而是透過該裝置作業系統提供的繪圖指令，而他們需要的只有後端的資料，而這就是 Restful API 的功能，只是單純將後端的資料回傳給前端，通常使用的資料格式為 JSON，因為 JSON 在很多的平台上都有支援。

而一般的 HTTP method 有支援 GET、POST、PUT、PATCH、DELETE。

## Restful API Hello World
因為改成使用 Restful API 之後都不是回傳頁面，而是回傳 JSON，所以也不需要 template engine，要注意的是在接收 CLIENT 傳過來的請求時，要使用 JSON 的格式做解析，因此 bodyParser 的設定要改成 `app.use(bodyParser.json());`

``` JavaScript
const express = require('express');
const app = express();
const bodyParser = require('body-parser');

app.use(bodyParser.json());

const productRoutes = require('./routes/product');

app.use('/products', productRoutes);

app.listen(3030);
```

接著是回傳資料時，要改成使用 JSON 的格式回傳

``` JavaScript
exports.getProducts = (req, res, next) => {
  console.log('getProducs');
  res.status(200).json({
    products: [{ title: 'cloth', price: 200 }]
  })
}
```

## CORS 跨域存取問題
由於 HTTP 協定有一個同源政策的機制, 在用戶端呼叫 api 時只能夠呼叫同樣域名的 api, 如果說本地端與 server 端的網域不一樣的話, 那會有 cors error, 要解決這個問題只能夠從 server 上處理, 

但是以下可以跨域取得資源：
* <img />
* <video />, <audio />
* <iframe />
* <link rel="stylesheet" href />
* <script src="" />

那麼跨域請求的機制是在 request 中發出的 `Origin` 和 Response 中的 `Access-Control-Allow-Origin` 如果值是一樣或是 `Access-Control-Allow-Origin: '*'`, 代表允許任何網域存取資源），此時就會放寬 CORS 的限制，允許存取跨域資源。

### preflight
所謂的 preflight 就是請求會先以 HTTP OPTION 的方式送去另外一個網域敲門，確認沒問題後才會送出真正的請求

首先 HTTP 僅允許以下三種方法

* GET
* HEAD
* POST

如果不包含在內, 則會回傳 CORS 錯誤

另外 `CONTENT-TYPE` 僅允許以下三種

* application/x-www-form-urlencoded
* multipart/form-data
* text/plain

假如要送 `application/json` 的話必須要額外在後端回傳的 HEADER 當中設定

``` js
app.use((req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT, PATCH, DELETE');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    next();
});

```


