---
title: node.js 筆記 4 - Express.js 介紹
date: 2019-10-27 10:37:01
tags:
  - Node
categories: 前端
---

在前面有提到使用 node.js 在 parse request body 的時候，會需要撰寫監聽事件將所有的 buffer 匯集之後，才能取得正確的資訊，但這個步驟過於繁瑣，有一些框架會將這些 code 寫好並抽象化成一組 function 讓我們方便使用。

而 Express.js 是目前比較多人在使用的框架，而替代的框架也很多比如說 ROR、PHP、Java、.NET ... 等，但是因為 Express 的語言也是 JavaScript 所以如果剛開始學 JavaScript 的前端如果想要轉成後端，Express 也是很便利的切入點。

## 安裝 Express.js
首先會需要安裝 Express.js 套件

```
npm install --save express
```

接下來會安裝 `nodemon` 這個套件，運行之後會不斷監聽專案的檔案內容是否有變動，如果有的話會立即反應到畫面上。

``` 
npm i --save-dev nodemon
```

之後要在 package.json 的 script 上加入 nodemon 的指令

``` json
{
  "name": "ch4-express",
  "version": "1.0.0",
  "description": "",
  "main": "all.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "nodemon ./app.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.17.1"
  },
  "devDependencies": {
    "nodemon": "^1.19.4"
  }
}
```

最後是 app.js 的程式碼

``` JavaScript
const http = require('http');
const express = require('express');

const app = express();

const server = http.createServer(app);
server.listen(3000);
```

## middleware
中介層是有點像守門員的概念，可以在這中介層進行驗證的程序，假如說沒有通過驗證便不能繼續下一個程序。

``` JavaScript
const express = require('express');

const app = express();

app.use((req, res, next) => {
  console.log('middleware1');
  next();
});

app.use((req, res, next) => {
  console.log('middleware2');
  res.send('Hello World');
})

app.listen(3000);
```

## handle route
在處理 route 時要注意，接收到的 route 如果是 `/` 就代表所有的 url，所以在執行順序上 `/` 要擺在最後面。

``` JavaScript
const express = require('express');

const app = express();

app.use('/about', (req, res, next) => {
  res.send('<h1>關於我們</h1>')
})

app.use('/', (req, res, next) => {
  res.send('<h1>首頁</h1>')
})

app.listen(3000);
```

## parse request body
如果說要取得 request body 可以引入一個套件 `body-parser`，這個套件，就不用像 node.js 一樣還要去監聽傳送過來的 buffer，在一開始必須要先加入到 middleware `app.use(bodyParser.urlencoded({ extended: false }))`

``` 
npm i --save body-parser
```

``` JavaScript
const express = require('express');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.urlencoded({ extended: false }))

app.use('/about', (req, res, next) => {
  res.send('<form action="add-cart" method="POST"><input type="text" name="title" /><button type="submit">submit</form>')
})

app.use('/add-cart', (req, res, next) => {
  console.log(req.body);
})

app.use('/', (req, res, next) => {
  res.send('<h1>首頁</h1>')
})
app.listen(3000);
```

## 設定 http method
http 的 method 大致上分為 `get`、`post`、`update`、`delete` 這幾個，如果說想要限制 client 呼叫的方法，那可以使用 `app.get` 或 `app.post`

``` JavaScript
const express = require('express');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.urlencoded({ extended: false }))

app.get('/about', (req, res, next) => {
  res.send('<form action="add-cart" method="POST"><input type="text" name="title" /><button type="submit">submit</form>')
})

app.post('/add-cart', (req, res, next) => {
  console.log(req.body);
})

app.use('/', (req, res, next) => {
  res.send('<h1>首頁</h1>')
})

app.listen(3000);
```

## express router
上面的寫法都會將 router 的處理都放置在一個檔案裏面，我們可以將 router 拆分至一個獨立的檔案裡面，並且在 root 去引用。

---> admin.js
``` JavaScript
const express = require('express');
const router = express.Router();

router.get('/add-product', (req, res, next) => {
  res.send('<form action="product" method="POST"><input type="text" name="title" /><button type="submit">submit</form>')
});

router.post('/product', (req, res, next) => {
  console.log(req.body);
  res.redirect('/');
})

module.exports = router;
```

----> app.js
``` JavaScript
const express = require('express');
const bodyParser = require('body-parser');

const app = express();
const adminRoutes = require('./routes/admin');
app.use(bodyParser.urlencoded({ extended: false }))

app.use(adminRoutes);

app.listen(3000);
```

在使用 adminRoutes 時，可以在前面加上路由前綴

``` JavaScript
app.use('/admin', adminRoutes);
```

## 404 page

如果說目前進入的頁面不存在，可以在最後導入到一個 404 的頁面
``` JavaScript
const express = require('express');
const bodyParser = require('body-parser');

const app = express();
const adminRoutes = require('./routes/admin');
app.use(bodyParser.urlencoded({ extended: false }))

app.use(adminRoutes);

----> app.use((req, res, next) => {
  res.status(404).send('<h1>404 not found</h1>');
})

app.listen(3000);
```

## 回傳頁面
如果不想要直接把 HTML hard code 在 JavaScript 裡面，可以預先定義 HTML 檔案，並且使用 `res.sendFile` 將頁面回傳，但要注意這個檔案位置必須要是絕對路徑，因此可以使用 `__dirname` 取得當下檔案在作業系統中的位置。

`path.join` 是可以將多個位置串聯起來的 helper function。

``` JavaScript
const path = require('path');
const express = require('express');
const router = express.Router();

router.get('/add-product', (req, res, next) => {
  res.sendFile(path.join(__dirname, '../', 'views', 'about.html'));
});

router.post('/product', (req, res, next) => {
  console.log(req.body);
  res.redirect('/');
})

module.exports = router;
```

當然 404 的頁面也可以這樣處理
``` JavaScript
app.use((req, res, next) => {
  res.status(404).sendFile(path.join(__dirname, 'views', '404.html'));
})
```

## 設定公用檔案
在 express 可以設定公用檔案，這個檔案可以直接透過網路連結取得，不需要進行驗證。

寫法上需要使用以下語法設定公用資料夾

``` JavaScript
app.use(express.static(path.join(__dirname, 'public')));
```

而在 HTML 裡面可以直接引入 public 資料夾內的資源檔

``` HTML
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="/css/all.css">
</head>
<body>
  <h1>關於我們</h1>
  <div class="box"></div>
</body>
</html>
```