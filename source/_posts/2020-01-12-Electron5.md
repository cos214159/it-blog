---
title: Electron - 5 session 和 cookie
date: 2020-01-12 09:32:07
tags:
  - Electron
categories: 前端
---

## session

Session 是一個用於紀錄網頁資訊的資料庫，Electron 會建立一個 session 然後被底下的 browser window 共用(也就是 webContent data)，那使用 session 的方式如下

``` js
let ses = mainWindow.webContents.session
console.log('ses = ', ses)
```

而因為 electron 只建立一個 session 給底下的 webContent 共用，所以假使有兩個 webContent 取到的 session 會是同一個，除此之外透過預設 session 物件取得的 session 也會是同一個

``` js
let ses = mainWindow.webContents.session 
let ses2 = secWindow.webContents.session
let defaultSes = session.defaultSession
```

假如想要切割一個獨立的 session 的話可以使用這個方法
``` js
let customSession = session.fromPartition('part1')
  secWindow = new BrowserWindow({
    width: 800, height: 600,
    x: 200, y: 200,
    webPreferences: {
      nodeIntegration: true,
      partition: customSession
    }
  })
```

預設這個方法 session 會存在記憶體內，假如程式關閉那 session 所存的資料都會被清掉，如果想要保存下來那必須要用以下方式宣告，

``` js
let customSession = session.fromPartition('persist:part1')
```

## cookies
cookies 是在 session instance 下的一個屬性，使用的方式如下

``` js
let ses = session.defaultSession

let getCookies = () => {
  ses.cookies.get({ name:'cookie1' }, (err, cookies) => {
    console.log(cookies)
  })
}
```

我們可以在等待網頁載入完成後查看該網頁的 cookies
``` js
mainWindow.webContents.on('did-finish-load', e => {
  getCookies()
})
```

而若是要設定 cookies 的話，可以用以下作法，而這樣設定並沒有過期時間，所以這個 cookie 在應用程式關掉之後就會消失

``` js
let cookie = { url:'https://myappdomain.com', name:'cookie1', value:'electron' }

ses.cookies.set( cookie, err => {
  console.log('cookie1 set')
  getCookies()
})
```

如果要讓 cookie 可以持續保存的話，要設定過期時間

``` js
let cookie = { url:'https://myappdomain.com', name:'cookie1', value:'electron', expirationDate:1613852855 }
```

而刪除 cookies 的方法為
``` js
ses.cookies.remove('https://myappdomain.com', 'cookie1', err => {
  getCookies()
})
```

## 下載 callback 事件

`will-download` 事件會在有檔案被下載的時候被觸發，該事件會回傳三個參數

* e 為事件物件
* downloadItem: 是關於下載檔案的資訊
* webContents: 是該檔案在哪一個 browser window 下載的

``` js
  ses.on('will-download', (e, downloadItem, webContents) => {

    let fileName = downloadItem.getFilename()
    let fileSize = downloadItem.getTotalBytes()

    // Save to desktop
    downloadItem.setSavePath(app.getPath('desktop') + `/${fileName}`)

    downloadItem.on('updated', (e, state) => {

      let received = downloadItem.getReceivedBytes()

      if (state === 'progressing' && received) {
        let progress = Math.round((received/fileSize)*100)
        webContents.executeJavaScript(`window.progress.value = ${progress}`)
      }
    })
  })

```