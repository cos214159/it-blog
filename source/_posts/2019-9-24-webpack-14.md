---
title: webpack 筆記 (14) - Babel
date: 2019-09-24 16:11:25
tags: 
  - webpack
categories: 前端
---

Babel 是能夠將 ECMAScript 2015+ 語法編譯成 ES5，得以在較多瀏覽器底下執行的工具。

## 安裝套件
```
npm install --save-dev @babel/core @babel/cli @babel/preset-env
npm install --save @babel/polyfill
```

底下這三個套件，主要是在開發中的階段會使用到
* @babel/cli : 可以讓我們在終端機上使用 babel
* @babel/core : babel 的核心程式碼
* @babel/preset-env : 這個在後續會講到

比較特別的是這個套件 @babel/polyfill 這是在發布的環境下還會使用的套件
* @babel/polyfill

## 開始進行編譯
首先先建立一個有 ES6 語法的檔案，es6.js，可以看到裡面有用到 const、let 的宣告關鍵字，還有箭頭函式

``` JavaScript
const fn = () => 1;
let a = 1;
```
而這些 ES6 的語法因為他是不能運行在所有的瀏覽器，所以這時候我們要依靠 babel 去把這些 ES6 的語法轉成 ES5，這樣就得以運行在大部分的瀏覽器底下囉。

這個時候因為我們有安裝了 @babel/core 以及 @babel/cli 所以可以直接在終端機使用 babel 的功能，那我們先來使用以下指令。

```
npx babel source/es6.js
```
![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/babel_1.png?alt=media&token=b8137af7-456c-4769-87c3-bda87da7e42c)

這個時候編譯出來的結果，在上圖藍框的地方，我們會發現到他跟原本的程式碼長的一模一樣，難不成是 babel 失靈了 ? 在他的官方文件上有寫到這麼一段

Since we haven’t told it to apply any transformations yet, the output code will be identical to the input (exact code styling is not preserved). We can specify what transformations we want by passing them as options.

意思大概是說，我們只是有讓 babel 去解析這段 code，但是並沒有特別註記，要怎麼把 let、const 以及箭頭函式轉成 ES5 的程式碼，所以輸出結果會跟原本是一致的，就是等於沒做的意思。

這個時候必須仰賴 Plugins 的幫忙，https://babeljs.io/docs/en/plugins ，plugins 定義的很多轉換 ES6 程式碼的套件，比方說以上述程式碼，若是我們想要轉換 箭頭函式則必須安裝以下套件。

``` JavaScript
npm install --save-dev @babel/plugin-transform-arrow-functions
```

然後把剛剛執行的 babel 指令再加上 一些參數進去

```
npx babel source/es6.js --plugins=@babel/plugin-transform-arrow-functions
```

![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/babel_2.png?alt=media&token=c1223e9c-1b5f-4737-a954-846c085b735e)

這個時候可以發現到，輸出的結果原本的箭頭函式就被改成傳統函式了，那麼 const 和 let 呢 ? 當然也是必須要安裝相對應的 plugins 套件，才可以進行轉換。

這時候當然會覺得很麻煩，有沒有單純只設定一個參數就可以讓 babel 知道要怎麼轉換 ES6 的所有語法呢 ? 這時候就要依靠最一開始安裝的 @babel/preset-env 套件

## @babel/preset-env
這個套件可以讓我們不用針對自己撰寫的程式碼去找相對應的 plugin 套件各別去設定，執行指令如下

```
npx babel source/es6 --presets=@babel/env
```
![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/babel_3.png?alt=media&token=9d8902b9-0278-454d-86b8-692fae257bb2)

這時候可以發現，原本的程式碼，不管是 let、const 或是箭頭函式都被轉換成 var 以及傳統函式，所以使用 @babel/preset-env 可以大幅降低我們開發的時間，因為不用去下載對應的 plugins。

## 最後需要一個設定檔
其實有蠻多的工具或語言，像 eslint、typescript、webpack … 等，他們可以設定的參數非常多，若是我們都在指令上註記這些參數的話，那在開發上會有一點辛苦，所以額外都會有一個檔案會放置這一些設定參數，在執行的時候可以去讀取， 我們先建立一個設定檔 `babel.config.js`

``` JavaScript
module.exports = {
  presets: [
    [
      "@babel/env",
    ],
  ]
}
```

在這個設定檔裡面，有加入我們安裝的 @babel/preset-env 設定，而之後我們在使用指令時，就不用像剛剛打的那麼麻煩

```
npx babel source/es6.js
```

![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/babel_4.png?alt=media&token=a0c1ccb5-d6e4-42e6-9af3-1e2e26673917)

這個時候可以發現，我們不用在指令上附加 preset 的參數，最後執行的結果還是可以成功將 ES6 的語法轉成 ES5 的語法。

## 設定檔 target 參數
``` JavaScript
module.exports = {
  presets: [
    [
      "@babel/env",
      {
        targets: {
          edge: "17",
          firefox: "60",
          chrome: "67",
          safari: "11.1",
        },
      },
    ],
  ]
}
```

在 babel.config.js 裡面我們還可以設定要編譯的目標瀏覽器的版本，若是有設定這個參數，preset 會載入在這些瀏覽器不支援的 plugins。

而瀏覽器的版本越新，已經支援到一些 ES6 的語法的話，env 就不會載入如箭頭函式或是 let、const 轉換的套件，來試試看上面這個設定檔

![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/babel_5.png?alt=media&token=4325f218-e1db-4040-9e98-b14a81ae4864)

可以看到因為我們剛剛有設定目標瀏覽器的版本，而這些瀏覽器他是可以運行 ES6 語法的，所以編譯過後的結果結構還是箭頭函式以及 let、const 的宣告方式。

## @babel/polyfill
當 babel 在轉換語法的時候，只支援轉換新的 JavaScript 語法，如箭頭函式或 let、const ，但是不支援轉換新的 API，比方說 Promise、Array.from，當我們在撰寫這樣的語法時，若是在較舊的瀏覽器下是無法運行的。

這個時候可以利用 polyfill 去實現瀏覽器不能運行的功能，polyfill 本身是一個函式庫，若是我們的程式有撰寫如 Promise、Array.from、Object.assign 的功能時，可以從這個函式庫裡面引用對應的模組進來。

但是這樣子是一件很費工的事情，就像之前的 @babel/preset-env ㄧ樣，也是有設定可以自動去檢測我們的程式碼需要引入哪一些套件，就不用都手動去做。

在 babel.config.js 裡面，我們新增一個屬性 useBuiltIns，然後執行程式

``` JavaScript
module.exports = {
  presets: [
    [
      "@babel/env",
      {
        targets: {
          edge: "17",
          firefox: "60",
          chrome: "67",
          safari: "11.1",
        },
        useBuiltIns: "usage",
        corejs: '3.0.0',
      },
    ],
  ]
}
```
![Alt text](https://firebasestorage.googleapis.com/v0/b/it-blog-a274d.appspot.com/o/polyfill.png?alt=media&token=b5a02176-2aea-4f67-96f6-d9f2a067ebee)

編譯後的結果可以看到，babel 有自動為 promise 的語法引入一些額外的函式庫，而這也是為什麼 polyfill 在安裝的時候要以 - -save 安裝的原因，因為在專案實際發布時，這些函式庫是要跟著一起被打包出去的。

範例程式碼 : https://github.com/cos214159/webpack-tutorial/tree/master/chapter14-babel
